name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        type: choice
        options: [dev, stg, prd]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: &app_name otlp-api
  PROJECT_NAME: &project_name testing

jobs:
  pipeline:
    name: CI/CD Pipeline
    uses: mrops-br/gha-workflows/.github/workflows/_pipeline-golang.yaml@main
    permissions:
      contents: write         # For creating tags and releases
      packages: write         # For pushing to GHCR
      id-token: write         # For cosign signing
      security-events: write  # For vulnerability scanning
    secrets: inherit
    with:
      # Application configuration
      app-name: *app_name
      image-name: ${{ github.repository }}
      project-name: *project_name

      # Go configuration
      go-version: '1.25'
      working-directory: '.'
      dockerfile: Dockerfile

      # CI options
      enable-lint: true
      enable-test: false
      enable-coverage: false
      enable-lint-dockerfile: true
      dockerfile-failure-threshold: 'warning'

      # Security
      enable-signing: true
      enable-scanning: true
      scan-severity: 'CRITICAL,HIGH'

      # Release automation (on merge to main)
      enable-auto-release: true
      enable-changelog: true
      changelog-config: cliff.toml
